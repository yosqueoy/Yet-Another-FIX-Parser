jest.unmock("../src/FixParser");
jest.unmock("lodash");

import FixParser from '../src/FixParser';
import dic from "../res/FIX.json";

describe("FixParser", () => {
    it("parses a simple message", () => {
        const message = `8=FIX.4.1|9=154|35=6|49=BRKR|56=INVMGR|34=236|52=19980604-07:58:48|23=115685|28=N|55=SPMI.MI|54=2|27=200000|44=10100.000000|25=H|10=159|`;
        const expected = [{ "raw": "8=FIX.4.1|9=154|35=6|49=BRKR|56=INVMGR|34=236|52=19980604-07:58:48|23=115685|28=N|55=SPMI.MI|54=2|27=200000|44=10100.000000|25=H|10=159|", "prefix": "8=FIX.4.1|9=154|", "fields": [{ "tag_name": "MsgType", "tag": "35", "value": "INDICATION_OF_INTEREST" }, { "tag_name": "SenderCompID", "tag": "49", "value": "BRKR" }, { "tag_name": "TargetCompID", "tag": "56", "value": "INVMGR" }, { "tag_name": "MsgSeqNum", "tag": "34", "value": "236" }, { "tag_name": "SendingTime", "tag": "52", "value": "19980604-07:58:48" }, { "tag_name": "IOIID", "tag": "23", "value": "115685" }, { "tag_name": "IOITransType", "tag": "28", "value": "NEW" }, { "tag_name": "Symbol", "tag": "55", "value": "SPMI.MI" }, { "tag_name": "Side", "tag": "54", "value": "SELL" }, { "tag_name": "IOIQty", "tag": "27", "value": "200000" }, { "tag_name": "Price", "tag": "44", "value": "10100.000000" }, { "tag_name": "IOIQltyInd", "tag": "25", "value": "HIGH" }] }];
        const parser = new FixParser(dic);
        const result = parser.parseFixMsg(message);
        expect(result).toEqual(expected);
    });

    it("parses multiple messages", () => {
        const message = `8=FIX.4.1|9=112|35=0|49=BRKR|56=INVMGR|34=235|52=19980604-07:58:28|112=19980604-07:58:28|10=157|
8=FIX.4.1|9=90|35=0|49=INVMGR|56=BRKR|34=236|52=19980604-07:59:30|10=225|
        `;
        const expected = [{ "raw": "8=FIX.4.1|9=112|35=0|49=BRKR|56=INVMGR|34=235|52=19980604-07:58:28|112=19980604-07:58:28|10=157|", "prefix": "8=FIX.4.1|9=112|", "fields": [{ "tag_name": "MsgType", "tag": "35", "value": "HEARTBEAT" }, { "tag_name": "SenderCompID", "tag": "49", "value": "BRKR" }, { "tag_name": "TargetCompID", "tag": "56", "value": "INVMGR" }, { "tag_name": "MsgSeqNum", "tag": "34", "value": "235" }, { "tag_name": "SendingTime", "tag": "52", "value": "19980604-07:58:28" }, { "tag_name": "TestReqID", "tag": "112", "value": "19980604-07:58:28" }] }, { "raw": "8=FIX.4.1|9=90|35=0|49=INVMGR|56=BRKR|34=236|52=19980604-07:59:30|10=225|", "prefix": "8=FIX.4.1|9=90|", "fields": [{ "tag_name": "MsgType", "tag": "35", "value": "HEARTBEAT" }, { "tag_name": "SenderCompID", "tag": "49", "value": "INVMGR" }, { "tag_name": "TargetCompID", "tag": "56", "value": "BRKR" }, { "tag_name": "MsgSeqNum", "tag": "34", "value": "236" }, { "tag_name": "SendingTime", "tag": "52", "value": "19980604-07:59:30" }] }];
        const parser = new FixParser(dic);
        const result = parser.parseFixMsg(message);
        expect(result).toEqual(expected);
    });
    
    it("parses a message with semicolon separaters", () => {
        const message = `8=FIX.4.4;9=61;35=A;49=BRKR;56=INVMGR;98=0;34=1;52=20000426-12:05:08;108=30;10=143;`;
        const expected = [{ "raw": "8=FIX.4.4;9=61;35=A;49=BRKR;56=INVMGR;98=0;34=1;52=20000426-12:05:08;108=30;10=143;", "prefix": "8=FIX.4.4;9=61;", "fields": [{ "tag_name": "MsgType", "tag": "35", "value": "LOGON" }, { "tag_name": "SenderCompID", "tag": "49", "value": "BRKR" }, { "tag_name": "TargetCompID", "tag": "56", "value": "INVMGR" }, { "tag_name": "EncryptMethod", "tag": "98", "value": "NONE" }, { "tag_name": "MsgSeqNum", "tag": "34", "value": "1" }, { "tag_name": "SendingTime", "tag": "52", "value": "20000426-12:05:08" }, { "tag_name": "HeartBtInt", "tag": "108", "value": "30" }] }];
        const parser = new FixParser(dic);
        const result = parser.parseFixMsg(message);
        expect(result).toEqual(expected);
    });

    it("parses messages with ^A separator", () => {
        const message = `20160707-10:02:51.041 SNT-000183:8=FIX.4.4^A9=296^A35=s^A34=183^A49=12328^A50=1234^A52=20160707-01:02:51.039^A56=1^A57=1,6,F^A142=H3B00^A347=Shift_JIS^A40=2^A44=917.0000^A55= 7201 ^A59=0^A60=20160707
            -01:02:51.012^A548=QqfQfVd9m5YAAAXT 1B1^A549=1^A550=0^A8045=0^A8046=0^A552=2^A54=1^A11=QqfQfaiCVcYAAAAD 1B1^A38=100^A528=A^A54=2^A11=AAAB5Vd9Kp0AACGs 1B1^A38=100^A528=P^A10=202^A
20160707-10:02:51.214 RCV-000210:8=FIX.4.4^A9=276^A35=8^A34=210^A49=1^A50=1,6,F^A52=20160707-01:02:51.113^A56=12328^A57=1234^A97=N^A143=H3B00^A347=Shift_JIS^A6=0^A11=QqfQfaiCVcYAAAAD 1B1^A14=0^A17=5^A37=00QqfQfaiCVcYAAAAD 1B100000015^A38=100^A39=0^A44=917.0000^A54=1^A55= 7201 ^A150=0^A151=0^A528=A^A548=QqfQfVd9m5YAAAXT 1B1^A8026=100251^A8045=0^A10=104^A`;
        const expected = [{"raw":"20160707-10:02:51.041 SNT-000183:8=FIX.4.4^A9=296^A35=s^A34=183^A49=12328^A50=1234^A52=20160707-01:02:51.039^A56=1^A57=1,6,F^A142=H3B00^A347=Shift_JIS^A40=2^A44=917.0000^A55= 7201 ^A59=0^A60=20160707            -01:02:51.012^A548=QqfQfVd9m5YAAAXT 1B1^A549=1^A550=0^A8045=0^A8046=0^A552=2^A54=1^A11=QqfQfaiCVcYAAAAD 1B1^A38=100^A528=A^A54=2^A11=AAAB5Vd9Kp0AACGs 1B1^A38=100^A528=P^A10=202^A","prefix":"20160707-10:02:51.041 SNT-000183:8=FIX.4.4^A9=296^A","fields":[{"tag_name":"MsgType","tag":"35","value":"NEW_ORDER_s"},{"tag_name":"MsgSeqNum","tag":"34","value":"183"},{"tag_name":"SenderCompID","tag":"49","value":"12328"},{"tag_name":"SenderSubID","tag":"50","value":"1234"},{"tag_name":"SendingTime","tag":"52","value":"20160707-01:02:51.039"},{"tag_name":"TargetCompID","tag":"56","value":"1"},{"tag_name":"TargetSubID","tag":"57","value":"1,6,F"},{"tag_name":"SenderLocationID","tag":"142","value":"H3B00"},{"tag_name":"MessageEncoding","tag":"347","value":"FOR_USING_SJIS"},{"tag_name":"OrdType","tag":"40","value":"LIMIT"},{"tag_name":"Price","tag":"44","value":"917.0000"},{"tag_name":"Symbol","tag":"55","value":" 7201 "},{"tag_name":"TimeInForce","tag":"59","value":"DAY"},{"tag_name":"TransactTime","tag":"60","value":"20160707            -01:02:51.012"},{"tag_name":"CrossID","tag":"548","value":"QqfQfVd9m5YAAAXT 1B1"},{"tag_name":"CrossType","tag":"549","value":"CROSS_TRADE_WHICH_IS_EXECUTED_COMPLETELY_OR_NOT_BOTH_SIDES_ARE_TREATED_IN_THE_SAME_MANNER_THIS_IS_EQUIVALENT_TO_AN_ALL_OR_NONE"},{"tag_name":"CrossPrioritization","tag":"550","value":"NONE"},{"tag":"8045","value":"0"},{"tag":"8046","value":"0"},{"tag_name":"NoSides","tag":"552","value":"BOTH_SIDES"},{"tag_name":"Side","tag":"54","value":"BUY"},{"tag_name":"ClOrdID","tag":"11","value":"QqfQfaiCVcYAAAAD 1B1"},{"tag_name":"OrderQty","tag":"38","value":"100"},{"tag_name":"OrderCapacity","tag":"528","value":"AGENCY"},{"tag_name":"Side","tag":"54","value":"SELL"},{"tag_name":"ClOrdID","tag":"11","value":"AAAB5Vd9Kp0AACGs 1B1"},{"tag_name":"OrderQty","tag":"38","value":"100"},{"tag_name":"OrderCapacity","tag":"528","value":"PRINCIPAL"}]},{"raw":"20160707-10:02:51.214 RCV-000210:8=FIX.4.4^A9=276^A35=8^A34=210^A49=1^A50=1,6,F^A52=20160707-01:02:51.113^A56=12328^A57=1234^A97=N^A143=H3B00^A347=Shift_JIS^A6=0^A11=QqfQfaiCVcYAAAAD 1B1^A14=0^A17=5^A37=00QqfQfaiCVcYAAAAD 1B100000015^A38=100^A39=0^A44=917.0000^A54=1^A55= 7201 ^A150=0^A151=0^A528=A^A548=QqfQfVd9m5YAAAXT 1B1^A8026=100251^A8045=0^A10=104^A","prefix":"20160707-10:02:51.214 RCV-000210:8=FIX.4.4^A9=276^A","fields":[{"tag_name":"MsgType","tag":"35","value":"EXECUTION_REPORT"},{"tag_name":"MsgSeqNum","tag":"34","value":"210"},{"tag_name":"SenderCompID","tag":"49","value":"1"},{"tag_name":"SenderSubID","tag":"50","value":"1,6,F"},{"tag_name":"SendingTime","tag":"52","value":"20160707-01:02:51.113"},{"tag_name":"TargetCompID","tag":"56","value":"12328"},{"tag_name":"TargetSubID","tag":"57","value":"1234"},{"tag_name":"PossResend","tag":"97","value":"NO"},{"tag_name":"TargetLocationID","tag":"143","value":"H3B00"},{"tag_name":"MessageEncoding","tag":"347","value":"FOR_USING_SJIS"},{"tag_name":"AvgPx","tag":"6","value":"0"},{"tag_name":"ClOrdID","tag":"11","value":"QqfQfaiCVcYAAAAD 1B1"},{"tag_name":"CumQty","tag":"14","value":"0"},{"tag_name":"ExecID","tag":"17","value":"5"},{"tag_name":"OrderID","tag":"37","value":"00QqfQfaiCVcYAAAAD 1B100000015"},{"tag_name":"OrderQty","tag":"38","value":"100"},{"tag_name":"OrdStatus","tag":"39","value":"NEW"},{"tag_name":"Price","tag":"44","value":"917.0000"},{"tag_name":"Side","tag":"54","value":"BUY"},{"tag_name":"Symbol","tag":"55","value":" 7201 "},{"tag_name":"ExecType","tag":"150","value":"NEW"},{"tag_name":"LeavesQty","tag":"151","value":"0"},{"tag_name":"OrderCapacity","tag":"528","value":"AGENCY"},{"tag_name":"CrossID","tag":"548","value":"QqfQfVd9m5YAAAXT 1B1"},{"tag":"8026","value":"100251"},{"tag":"8045","value":"0"}]}];
        const parser = new FixParser(dic);
        const result = parser.parseFixMsg(message);
        expect(result).toEqual(expected);
    });
});
